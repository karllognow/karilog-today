<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>グレード選択（タマミツネ武器）</title>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    button { padding: 10px 15px; font-size: 16px; }

    /* モーダル */
    .modal {
      display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%;
      height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px;
    }
    .grade-grid {
      display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-top: 10px;
    }
    .grade-button {
      padding: 6px; border: 1px solid #ccc; cursor: pointer; text-align: center;
      background: #eee; border-radius: 4px;
    }
    .grade-button.disabled {
      background: #ddd; color: #aaa; pointer-events: none;
    }
    .grade-button.selected {
      background: #4CAF50; color: white;
    }
    #resultTable { margin-top: 20px; border-collapse: collapse; width: 100%; }
    #resultTable th, #resultTable td {
      border: 1px solid #ccc; padding: 8px; text-align: left;
    }
  </style>
</head>
<body>

<h2>グレードを選択</h2>
<button id="openModal">グレードを選ぶ</button>
<div id="selectedRange"></div>
<table id="resultTable"></table>

<!-- モーダル -->
<div id="gradeModal" class="modal">
  <div class="modal-content">
    <h3 id="selectionStep">現在のグレードを選択してください</h3>
    <div class="grade-grid" id="gradeGrid"></div>
    <button id="closeModal" style="margin-top:15px;">キャンセル</button>
  </div>
</div>

<script>
const allGrades = [
  "1-1","1-2","1-3","1-4","1-5",
  "2-1","2-2","2-3","2-4","2-5",
  "3-1","3-2","3-3","3-4","3-5",
  "4-1","4-2","4-3","4-4","4-5",
  "5-1","5-2","5-3","5-4","5-5",
  "6-1","6-2","6-3","6-4","6-5",
  "7-1","7-2","7-3","7-4","7-5",
  "8-1","8-2","8-3","8-4","8-5",
  "9-1","9-2","9-3","9-4","9-5",
  "10-1","10-2","10-3","10-4","10-5"
];
const startGrade = "5-1"; // タマミツネ武器の生産開始グレード
let weaponData = {};
let step = 0;
let selectedStart = null, selectedEnd = null;

// グレード比較用
function gradeIndex(grade) { return allGrades.indexOf(grade); }

fetch("tamamitsune_weapon.json")
  .then(res => res.json())
  .then(data => weaponData = data);

document.getElementById("openModal").onclick = () => {
  step = 0;
  selectedStart = null;
  selectedEnd = null;
  document.getElementById("selectionStep").textContent = "現在のグレードを選択してください";
  renderGrid();
  document.getElementById("gradeModal").style.display = "flex";
};

document.getElementById("closeModal").onclick = () => {
  document.getElementById("gradeModal").style.display = "none";
};

function renderGrid() {
  const grid = document.getElementById("gradeGrid");
  grid.innerHTML = "";
  allGrades.forEach(g => {
    const btn = document.createElement("div");
    btn.textContent = g;
    btn.className = "grade-button";
    if (gradeIndex(g) < gradeIndex(startGrade)) btn.classList.add("disabled");
    btn.onclick = () => {
      if (step === 0) {
        selectedStart = g;
        step = 1;
        document.getElementById("selectionStep").textContent = "目標のグレードを選択してください";
        renderGrid();
      } else if (step === 1) {
        selectedEnd = g;
        document.getElementById("gradeModal").style.display = "none";
        showResults();
      }
    };
    if (g === selectedStart || g === selectedEnd) btn.classList.add("selected");
    grid.appendChild(btn);
  });
}

function showResults() {
  const range = allGrades.slice(
    gradeIndex(selectedStart) + 1,
    gradeIndex(selectedEnd) + 1
  );
  const materialMap = {};
  let totalZenny = 0;

  range.forEach(g => {
    const info = weaponData[g];
    if (!info) return;
    totalZenny += info.zenny;
    info.materials.forEach(m => {
      if (!materialMap[m.name]) materialMap[m.name] = 0;
      materialMap[m.name] += m.count;
    });
  });

  document.getElementById("selectedRange").textContent =
    `強化範囲：${selectedStart} → ${selectedEnd}`;

  const table = document.getElementById("resultTable");
  table.innerHTML = "<tr><th>素材名</th><th>合計数</th></tr>";
  for (let name in materialMap) {
    const row = table.insertRow();
    row.insertCell().textContent = name;
    row.insertCell().textContent = materialMap[name];
  }
  const row = table.insertRow();
  row.insertCell().textContent = "必要ゼニー";
  row.insertCell().textContent = `${totalZenny} z`;
}
</script>

</body>
</html>
