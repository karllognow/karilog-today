let selectedMaterials = [];
let totalZeny = 0;

document.getElementById("search-button").addEventListener("click", async () => {
  const selectedValue = document.getElementById("monster-select").value;
  if (!selectedValue) {
    alert("モンスターを選択してください");
    return;
  }

  const res = await fetch("monster_materials.json");
  const data = await res.json();
  const materials = data[selectedValue];

  const list = document.getElementById("materials-list");
  list.innerHTML = "";
  totalZeny = 0;
  selectedMaterials = [];

  materials.forEach(item => {
    const li = document.createElement("li");

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = item.name;
    checkbox.checked = true;
    checkbox.addEventListener("change", () => updateSelected(item, checkbox.checked));

    const label = document.createElement("label");
    label.textContent = `${item.name} × ${item.count}`;

    li.appendChild(checkbox);
    li.appendChild(label);
    list.appendChild(li);

    selectedMaterials.push(item);
    totalZeny += item.zeny || 0;
  });

  document.getElementById("total-zeny").textContent = `合計ゼニー：${totalZeny.toLocaleString()} z`;
});

function updateSelected(item, isChecked) {
  if (isChecked) {
    selectedMaterials.push(item);
    totalZeny += item.zeny || 0;
  } else {
    selectedMaterials = selectedMaterials.filter(m => m.name !== item.name);
    totalZeny -= item.zeny || 0;
  }
  document.getElementById("total-zeny").textContent = `合計ゼニー：${totalZeny.toLocaleString()} z`;
}

document.getElementById("register-button").addEventListener("click", () => {
  if (selectedMaterials.length === 0) {
    alert("登録する素材を選んでください！");
    return;
  }

  document.getElementById("register-button").style.display = "none";
  const timerDiv = document.getElementById("ad-timer");
  timerDiv.style.display = "block";

  let timeLeft = 30;
  const interval = setInterval(() => {
    document.getElementById("timer").textContent = timeLeft;
    timeLeft--;
    if (timeLeft < 0) {
      clearInterval(interval);
      timerDiv.style.display = "none";
      document.getElementById("register-button").style.display = "block";

      // 保存処理
      const saveData = {
        materials: selectedMaterials,
        zeny: totalZeny,
        date: new Date().toISOString()
      };
      localStorage.setItem("equipRegister", JSON.stringify(saveData));
      alert("登録が完了しました！（Today・Weeklyに反映予定）");
    }
  }, 1000);
});